<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${editing} ? 'Edit Scheme Course' : 'Add Scheme Course'">Scheme Course Form</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
</head>
<body>
<!-- HEADER -->
<div th:replace="fragments/header :: header"></div>

<!-- NAVBAR -->
<div th:replace="fragments/navbar :: navbar"></div>
<div class="container mt-3">
    <h2 th:text="${editing} ? 'Edit Scheme Course' : 'Add Scheme Course'"></h2>

    <form th:action="@{/admin/programs/{programId}/schemes/{schemeId}/{splid}/scheme-courses/save(programId=${programId}, schemeId=${schemeId}, splid=${splid})}"
          th:object="${schemeCourse}" method="post">

        <div class="mb-3">
            <label class="form-label">Semester</label>
            <input type="hidden" th:field="*{termName}" />
            <input type="hidden" th:field="*{programYear}" />
            <input type="hidden" th:field="*{semesterName}" />
            <input type="hidden" th:field="*{termSeqNo}" />
            <input type="hidden" th:field="*{semNo}" />
            <input type="text" class="form-control" th:value="*{semesterName}" disabled />
        </div>

        <div class="mb-3">
            <label class="form-label">Course Serial No</label>
            <input type="hidden" th:field="*{courseSrNo}" />
            <input type="number" class="form-control" th:value="*{courseSrNo}" disabled />
        </div>

        <div class="mb-3">
            <label class="form-label">Course (searchable)</label>
            <input list="coursesList" id="courseSearch" class="form-control" placeholder="Type to search (code or name)..."
                   th:value="${selectedCourseDisplay}" th:attr="disabled=${editing} ? 'disabled' : null" />
            <datalist id="coursesList">
                <option th:each="mc : ${masterCourses}"
                        th:value="${mc.crscode} + ' - ' + ${mc.crsname}"
                        th:attr="data-crsid=${mc.crsid}, data-crscode=${mc.crscode}, data-crsname=${mc.crsname}, data-lectures=${mc.crslectures}, data-tutorials=${mc.crstutorials}, data-practicals=${mc.crspracticals}, data-credits=${mc.crscreditpoints}">
                </option>
            </datalist>
            <input type="hidden" id="crsid" th:field="*{crsid}" />
        </div>

        <div class="mb-3">
            <label class="form-label">Course Type</label>
            <select class="form-select" th:field="*{ctpcode}" required>
                <option th:each="ct : ${courseTypes}"
                        th:value="${ct.ctpcode}"
                        th:text="${ct.ctpcode} + ' - ' + ${ct.ctpname}"></option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Course Code</label>
            <input type="text" class="form-control" th:field="*{courseCode}" required />
        </div>

        <div class="mb-3">
            <label class="form-label">Course Title</label>
            <input type="text" class="form-control" th:field="*{courseTitle}" required />
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Lecture Hours</label>
                <input type="number" step="1" class="form-control" th:field="*{lectureHours}" />
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Tutorial Hours</label>
                <input type="number" step="1" class="form-control" th:field="*{tutorialHours}" />
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Practical Hours</label>
                <input type="number" step="1" class="form-control" th:field="*{practicalHours}" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Total Credits</label>
            <input type="number" step="1" class="form-control" th:field="*{totalCredits}" />
        </div>

        <input type="hidden" th:field="*{schemeId}" />
        <input type="hidden" th:field="*{splid}" />

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <a th:href="@{/admin/programs/{programId}/schemes/{schemeId}/{splid}/scheme-courses(programId=${programId}, schemeId=${schemeId}, splid=${splid})}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>

    <!-- FOOTER -->
    <div th:replace="fragments/footer :: footer"></div>
</div>

<script>
    // When a course is selected from the datalist, fill hidden crsid and autofill fields
    const courseInput = document.getElementById('courseSearch');
    const datalist = document.getElementById('coursesList');
    const crsidInput = document.getElementById('crsid');

    courseInput && courseInput.addEventListener('input', function () {
        const val = this.value;
        // find matching option
        const opts = datalist && datalist.options;
        if (!opts) return;
        for (let i = 0; i < opts.length; i++) {
            const opt = opts[i];
            if (opt.value === val) {
                const dataset = opt.dataset;
                if (crsidInput) crsidInput.value = dataset.crsid || '';
                // autofill fields
                const courseCodeEl = document.querySelector('input[name="courseCode"]');
                const courseTitleEl = document.querySelector('input[name="courseTitle"]');
                const lectureEl = document.querySelector('input[name="lectureHours"]');
                const tutorialEl = document.querySelector('input[name="tutorialHours"]');
                const practicalEl = document.querySelector('input[name="practicalHours"]');
                const creditsEl = document.querySelector('input[name="totalCredits"]');
                if (courseCodeEl) courseCodeEl.value = dataset.crscode || '';
                if (courseTitleEl) courseTitleEl.value = dataset.crsname || '';
                if (lectureEl) lectureEl.value = dataset.lectures || '';
                if (tutorialEl) tutorialEl.value = dataset.tutorials || '';
                if (practicalEl) practicalEl.value = dataset.practicals || '';
                if (creditsEl) creditsEl.value = dataset.credits || '';
                return;
            }
        }
        // if no exact match, clear crsid
        if (crsidInput) crsidInput.value = '';
    });
</script>
</body>
</html>