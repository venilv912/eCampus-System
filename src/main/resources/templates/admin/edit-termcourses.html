<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Term Courses</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <!-- CSRF Token for JavaScript -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>

<!-- HEADER -->
<div th:replace="fragments/header :: header"></div>

<!-- NAVBAR -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-3">

    <h2>Edit Term Courses</h2>
    <h4 th:text="'Academic Year: ' + ${academicYear.ayrname} + ' | Term: ' + ${term.trmname}"></h4>

    <a th:href="@{/admin/term-courses}" class="btn btn-secondary mb-3">‚Üê Back to Term Courses</a>

    <!-- Flash Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${warning}" class="alert alert-warning alert-dismissible fade show" role="alert">
        <span th:text="${warning}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${info}" class="alert alert-info alert-dismissible fade show" role="alert">
        <span th:text="${info}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- ELECTIVES TABLE -->
    <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4>Electives</h4>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addElectiveModal">
                Add Elective
            </button>
        </div>

        <form th:action="@{/admin/term-courses/save}" method="post">
            <input type="hidden" name="termId" th:value="${termId}" />
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="background-color: #003366; color: white;">Course Code</th>
                        <th style="background-color: #003366; color: white;">Course Title</th>
                        <th style="background-color: #003366; color: white;">Credit Hours</th>
                        <th style="background-color: #003366; color: white;">Total Marks</th>
                        <th style="background-color: #003366; color: white;">Faculty</th>
                        <th style="background-color: #003366; color: white;">Slot</th>
                        <th style="background-color: #003366; color: white;">Delete</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="tc, iterStat : ${electives}">
                        <input type="hidden" name="tcrid" th:value="${tc.tcrid}" />
                        <td th:text="${tc.crscode}"></td>
                        <td th:text="${tc.crstitle}"></td>
                        <td th:text="${tc.credithours}"></td>
                        <td>
                            <input type="number" name="tcrmarks" th:value="${tc.tcrmarks}" class="form-control form-control-sm" style="width:80px;" required />
                        </td>
                        <td>
                            <input list="facultyList" th:id="'facultySearch_elec_' + ${iterStat.index}" class="form-control form-control-sm faculty-search" 
                                   placeholder="Search faculty..." style="width:200px;"
                                   th:value="${tc.facultyName}"
                                   th:attr="data-hidden-id=${'facultyId_elec_' + iterStat.index}" />
                            <input type="hidden" name="tcrfacultyid" th:id="'facultyId_elec_' + ${iterStat.index}" th:value="${tc.tcrfacultyid}" />
                        </td>
                        <td>
                            <input type="number" name="tcrslot" th:value="${tc.tcrslot}" class="form-control form-control-sm" style="width:80px;" />
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger" 
                                    th:onclick="'deleteTermCourse(' + ${tc.tcrid} + ', ' + ${termId} + ')'">
                                Delete
                            </button>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(electives)}">
                        <td colspan="7" class="text-center text-muted">No elective courses found</td>
                    </tr>
                </tbody>
            </table>
            <div th:if="${!#lists.isEmpty(electives)}" class="mb-3">
                <button type="submit" class="btn btn-success">Save Electives</button>
            </div>
        </form>
    </div>

    <!-- CORE / INTERNSHIPS / PROJECTS TABLE -->
    <div class="mt-5">
        <h4>Core / Internships / Projects</h4>

        <form th:action="@{/admin/term-courses/save}" method="post">
            <input type="hidden" name="termId" th:value="${termId}" />
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="background-color: #003366; color: white;">Course Code</th>
                        <th style="background-color: #003366; color: white;">Course Title</th>
                        <th style="background-color: #003366; color: white;">Credit Hours</th>
                        <th style="background-color: #003366; color: white;">Total Marks</th>
                        <th style="background-color: #003366; color: white;">Faculty</th>
                        <th style="background-color: #003366; color: white;">Slot</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="tc, iterStat : ${coreAndIP}">
                        <input type="hidden" name="tcrid" th:value="${tc.tcrid}" />
                        <td th:text="${tc.crscode}"></td>
                        <td th:text="${tc.crstitle}"></td>
                        <td th:text="${tc.credithours}"></td>
                        <td>
                            <input type="number" name="tcrmarks" th:value="${tc.tcrmarks}" class="form-control form-control-sm" style="width:80px;" required />
                        </td>
                        <td>
                            <input list="facultyList" th:id="'facultySearch_core_' + ${iterStat.index}" class="form-control form-control-sm faculty-search" 
                                   placeholder="Search faculty..." style="width:200px;"
                                   th:value="${tc.facultyName}"
                                   th:attr="data-hidden-id=${'facultyId_core_' + iterStat.index}" />
                            <input type="hidden" name="tcrfacultyid" th:id="'facultyId_core_' + ${iterStat.index}" th:value="${tc.tcrfacultyid}" />
                        </td>
                        <td>
                            <input type="number" name="tcrslot" th:value="${tc.tcrslot}" class="form-control form-control-sm" style="width:80px;" />
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(coreAndIP)}">
                        <td colspan="6" class="text-center text-muted">No core/internship/project courses found</td>
                    </tr>
                </tbody>
            </table>
            <div th:if="${!#lists.isEmpty(coreAndIP)}" class="mb-3">
                <button type="submit" class="btn btn-success">Save Core/IP Courses</button>
            </div>
        </form>
    </div>

    <!-- Shared Faculty Datalist -->
    <datalist id="facultyList">
        <option th:each="faculty : ${allFaculty}"
                th:value="${faculty.ufullname}"
                th:attr="data-uid=${faculty.uid}">
        </option>
    </datalist>

    <!-- FOOTER -->
    <div th:replace="fragments/footer :: footer"></div>

</div>

<!-- Add Elective Modal -->
<div class="modal fade" id="addElectiveModal" tabindex="-1" aria-labelledby="addElectiveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addElectiveModalLabel">Add Elective Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/admin/term-courses/add-elective}" method="post" id="addElectiveForm" onsubmit="return validateAddElective()">
                <div class="modal-body">
                    <input type="hidden" name="termId" th:value="${termId}" />
                    
                    <div class="mb-3">
                        <label class="form-label">Course (searchable)</label>
                        <input list="coursesList" id="courseSearch" class="form-control" 
                               placeholder="Type to search (code or name)..." required />
                        <datalist id="coursesList">
                            <option th:each="course : ${allCourses}"
                                    th:value="${course.crscode} + ' - ' + ${course.crsname}"
                                    th:attr="data-crsid=${course.crsid}">
                            </option>
                        </datalist>
                        <input type="hidden" id="crsid" name="crsid" />
                        <div id="courseError" class="text-danger mt-1" style="display:none;">Please select a valid course from the dropdown.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Elective</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Validate Add Elective form before submission
    function validateAddElective() {
        const crsidInput = document.getElementById('crsid');
        const courseError = document.getElementById('courseError');
        const courseSearch = document.getElementById('courseSearch');
        
        if (!crsidInput || !crsidInput.value || crsidInput.value.trim() === '') {
            if (courseError) courseError.style.display = 'block';
            if (courseSearch) courseSearch.classList.add('is-invalid');
            return false;
        }
        if (courseError) courseError.style.display = 'none';
        if (courseSearch) courseSearch.classList.remove('is-invalid');
        return true;
    }

    // When a course is selected from the datalist, fill hidden crsid
    const courseInput = document.getElementById('courseSearch');
    const datalist = document.getElementById('coursesList');
    const crsidInput = document.getElementById('crsid');

    courseInput && courseInput.addEventListener('input', function () {
        const val = this.value;
        const opts = datalist && datalist.options;
        const courseError = document.getElementById('courseError');
        if (!opts) return;
        for (let i = 0; i < opts.length; i++) {
            const opt = opts[i];
            if (opt.value === val) {
                const dataset = opt.dataset;
                if (crsidInput) crsidInput.value = dataset.crsid || '';
                // Clear error when valid course is selected
                if (courseError) courseError.style.display = 'none';
                this.classList.remove('is-invalid');
                return;
            }
        }
        // if no exact match, clear crsid
        if (crsidInput) crsidInput.value = '';
    });

    // Handle faculty search dropdowns
    const facultyDatalist = document.getElementById('facultyList');
    const facultySearchFields = document.querySelectorAll('.faculty-search');

    facultySearchFields.forEach(function(field) {
        field.addEventListener('input', function() {
            const val = this.value;
            const hiddenFieldId = this.getAttribute('data-hidden-id');
            const hiddenField = document.getElementById(hiddenFieldId);
            
            if (!facultyDatalist || !hiddenField) return;
            
            const opts = facultyDatalist.options;
            for (let i = 0; i < opts.length; i++) {
                const opt = opts[i];
                if (opt.value === val) {
                    hiddenField.value = opt.dataset.uid || '';
                    return;
                }
            }
            // if no exact match, clear the hidden field
            hiddenField.value = '';
        });
    });

    // Delete term course function (to avoid nested forms)
    function deleteTermCourse(tcrid, termId) {
        if (!confirm('Are you sure you want to delete this elective?')) {
            return;
        }
        // Create and submit a form dynamically
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/term-courses/delete';
        
        const tcridInput = document.createElement('input');
        tcridInput.type = 'hidden';
        tcridInput.name = 'tcrid';
        tcridInput.value = tcrid;
        form.appendChild(tcridInput);
        
        const termIdInput = document.createElement('input');
        termIdInput.type = 'hidden';
        termIdInput.name = 'termId';
        termIdInput.value = termId;
        form.appendChild(termIdInput);
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_csrf';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
</script>

</body>
</html>
